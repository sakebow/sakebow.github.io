<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.0.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/fav/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/fav/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/fav/favicon-16x16.png">
  <link rel="mask-icon" href="/images/fav/android-chrome-512x512.png" color="#222">
  <link rel="manifest" href="/images/fav/site.manifest.json">
  <meta name="msvalidate.01" content="baidu_verify_codeva-pRzwrRUz9m.html">

<link rel="stylesheet" href="/css/main.css">


  <script src='https://unpkg.com/mermaid@/dist/mermaid.min.js'></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({theme: 'forest'});
    }
  </script>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.css" integrity="sha256-6cQIC71/iBIYXFK+0RHAvwmjwWzkWd+r7v/BX3/vZDc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/pink/pace-theme-fill-left.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"sakebow.cn","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":true,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":10,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="前言本文主要是继续深挖Tongyi类，并进一步探究详细的流程。部分内容在面试中比较常见，但是个人理解不够全面，能够为大家给出的解释有限。">
<meta property="og:type" content="article">
<meta property="og:title" content="通义千问的小机器人到底是怎么个事">
<meta property="og:url" content="http://sakebow.cn/2024/06/11/LLM/qwen-construct/index.html">
<meta property="og:site_name" content="小小万事屋">
<meta property="og:description" content="前言本文主要是继续深挖Tongyi类，并进一步探究详细的流程。部分内容在面试中比较常见，但是个人理解不够全面，能够为大家给出的解释有限。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-06-11T09:57:35.000Z">
<meta property="article:modified_time" content="2024-06-14T01:25:27.568Z">
<meta property="article:author" content="sakebow">
<meta property="article:tag" content="langchain">
<meta property="article:tag" content="qwen">
<meta property="article:tag" content="LLM">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://sakebow.cn/2024/06/11/LLM/qwen-construct/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://sakebow.cn/2024/06/11/LLM/qwen-construct/","path":"2024/06/11/LLM/qwen-construct/","title":"通义千问的小机器人到底是怎么个事"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>通义千问的小机器人到底是怎么个事 | 小小万事屋</title>
  







<script async src="/lib/fireworks.js"></script>
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">小小万事屋</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">一个似乎什么都想做的网站</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">65</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">13</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">51</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5Tongyi%E7%B1%BB"><span class="nav-number">2.</span> <span class="nav-text">导入Tongyi类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%85%8D%E7%BD%AETongyi%E7%B1%BB"><span class="nav-number">3.</span> <span class="nav-text">配置Tongyi类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%BB%E5%8F%96api-key"><span class="nav-number">4.</span> <span class="nav-text">读取api-key</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#os%E9%85%8D%E7%BD%AE"><span class="nav-number">4.1.</span> <span class="nav-text">os配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#env%E9%85%8D%E7%BD%AE"><span class="nav-number">4.2.</span> <span class="nav-text">env配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#streamlit%E9%85%8D%E7%BD%AE"><span class="nav-number">4.3.</span> <span class="nav-text">streamlit配置</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#PromptTemplate"><span class="nav-number">5.</span> <span class="nav-text">PromptTemplate</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#LLMChain"><span class="nav-number">5.1.</span> <span class="nav-text">LLMChain</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%8D%A2%E6%8E%89LLMChain%EF%BC%88%E5%8F%AF%E9%80%89%EF%BC%89"><span class="nav-number">5.2.</span> <span class="nav-text">更换掉LLMChain（可选）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StuffDocumentsChain"><span class="nav-number">5.3.</span> <span class="nav-text">StuffDocumentsChain</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ConversationBufferMemory"><span class="nav-number">6.</span> <span class="nav-text">ConversationBufferMemory</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="sakebow"
      src="/images/avatar/avatar.jpg"
          onmouseover = "this.src='/images/avatar/avatarc.png'"
          onmouseout = "this.src='/images/avatar/avatar.jpg'"
      >
  <p class="site-author-name" itemprop="name">sakebow</p>
  <div class="site-description" itemprop="description">一个似乎什么都想做的小站</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/sakebow" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;sakebow" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/yao-fan-de-ma-nong" title="ZhiHu → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;yao-fan-de-ma-nong" rel="noopener me" target="_blank"><i class="fab fa-zhihu fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://sakebow.cn/2024/06/11/LLM/qwen-construct/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar/avatar.jpg">
      <meta itemprop="name" content="sakebow">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="小小万事屋">
      <meta itemprop="description" content="一个似乎什么都想做的小站">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="通义千问的小机器人到底是怎么个事 | 小小万事屋">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          通义千问的小机器人到底是怎么个事
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-06-11 17:57:35" itemprop="dateCreated datePublished" datetime="2024-06-11T17:57:35+08:00">2024-06-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-06-14 09:25:27" itemprop="dateModified" datetime="2024-06-14T09:25:27+08:00">2024-06-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/LLM/" itemprop="url" rel="index"><span itemprop="name">LLM</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>14 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文主要是继续深挖<code>Tongyi</code>类，并进一步探究详细的流程。部分内容在面试中比较常见，但是个人理解不够全面，能够为大家给出的解释有限。</p>
<span id="more"></span>

<h1 id="导入Tongyi类"><a href="#导入Tongyi类" class="headerlink" title="导入Tongyi类"></a>导入Tongyi类</h1><p><code>Tongyi</code>类是<code>langchain_community.llms</code>中的一个类。实际上，这个类是在<code>langchain_community.llms</code>文件夹下<code>tongyi.py</code>中的一个类，只不过因为<code>langchain_community.llms</code>文件夹下的<code>__init__.py</code>文件追加了一个方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_import_tongyi</span>() -&gt; <span class="type">Type</span>[BaseLLM]:</span><br><span class="line">  <span class="keyword">from</span> langchain_community.llms.tongyi <span class="keyword">import</span> Tongyi</span><br><span class="line">  <span class="keyword">return</span> Tongyi</span><br></pre></td></tr></table></figure>

<p>最终，在一个包含了无数个<code>if-else</code>的<code>__getattr__</code>方法中，会根据传入<code>name</code>的值判断执到底执行哪一个大模型的<code>import</code>方法。</p>
<p>这个意思就是说，我们假设现在新开发了一个大模型，叫做<code>Ninedays</code>（<del>就当这个叫做九天吧</del>），并存入<code>ninedays.py</code>。我们想要导入这个<code>Ninedays</code>大模型，也就可以通过<code>from langchain_community.llms import Ninedays</code>导入。</p>
<p>导入的过程将首先经过<code>__init__.py</code>方法中的<code>__getattr__</code>方法，用于访问没有直接定义出来的数据。此时，在<code>__getattr__</code>方法中增加：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> name == <span class="string">"Ninedays"</span>:</span><br><span class="line">  <span class="keyword">from</span> langchain_community.llms.ninedays <span class="keyword">import</span> Ninedays</span><br></pre></td></tr></table></figure>

<p>这个意思就是，我经过<code>__getattr__</code>访问到了<code>Ninedayes</code>这个<code>name</code>，并且通过大量的<code>if-else</code>查询到了这个执行条件，于是开始导入大模型。</p>
<p>这种方法是一种懒加载的实现方法，非常方便。</p>
<h1 id="配置Tongyi类"><a href="#配置Tongyi类" class="headerlink" title="配置Tongyi类"></a>配置Tongyi类</h1><p>在<code>langchain_community.llms</code>文件夹下的<code>tongyi.py</code>文件中，里面有这么几个属性：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">client: <span class="type">Any</span>  <span class="comment">#: :meta private:</span></span><br><span class="line">model_name: <span class="built_in">str</span> = <span class="string">"qwen-plus"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""Model name to use."""</span></span><br><span class="line">model_kwargs: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>] = Field(default_factory=<span class="built_in">dict</span>)</span><br><span class="line"></span><br><span class="line">top_p: <span class="built_in">float</span> = <span class="number">0.8</span></span><br><span class="line"><span class="string">"""Total probability mass of tokens to consider at each step."""</span></span><br><span class="line"></span><br><span class="line">dashscope_api_key: <span class="type">Optional</span>[<span class="built_in">str</span>] = <span class="literal">None</span></span><br><span class="line"><span class="string">"""Dashscope api key provide by Alibaba Cloud."""</span></span><br><span class="line"></span><br><span class="line">streaming: <span class="built_in">bool</span> = <span class="literal">False</span></span><br><span class="line"><span class="string">"""Whether to stream the results or not."""</span></span><br><span class="line"></span><br><span class="line">max_retries: <span class="built_in">int</span> = <span class="number">10</span></span><br><span class="line"><span class="string">"""Maximum number of retries to make when generating."""</span></span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><code>client</code>并不确定是什么，没有相关定义，但是会按照<code>llm.client.call</code>执行，其中<code>llm</code>是<code>Tongyi</code>类的实例。</li>
<li><code>model_name</code>是<code>qwen-plus</code>，表示默认的模型名称。</li>
<li><code>model_kwargs</code>是空字典，表示默认的模型参数。</li>
<li><code>top_p</code>是0.8，是<code>model_kwargs</code>中的<code>top_p</code>参数。</li>
<li><code>dashscope_api_key</code>是通义千问的<code>api-key</code>。</li>
<li><code>streaming</code>表示最终的输出是否是流式输出。</li>
<li><code>max_retries</code>是10，表示最多允许的重试次数。</li>
</ul>
<p>我们初始化的过程中，往往也是直接自定义这些参数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">llm = Tongyi(</span><br><span class="line">  dashscope_api_key=<span class="string">"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h1 id="读取api-key"><a href="#读取api-key" class="headerlink" title="读取api-key"></a>读取api-key</h1><p>读取的方式有很多种，包括<code>yaml</code>配置、<code>xml</code>配置、<code>txt</code>配置、<code>properties</code>配置乃至数据库配置等等，<code>Python</code>也为每一种配置都有特定的工具库，非常方便。下面仅介绍3种推荐配置方法。</p>
<h2 id="os配置"><a href="#os配置" class="headerlink" title="os配置"></a>os配置</h2><p>在<code>Tongyi</code>初始化的过程中，会执行一个<code>validate_environment</code>方法，将检查环境是否满足要求：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@root_validator()</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_environment</span>(<span class="params">cls, values: <span class="type">Dict</span></span>) -&gt; <span class="type">Dict</span>:</span><br><span class="line">  <span class="string">"""Validate that api key and python package exists in environment."""</span></span><br><span class="line">  values[<span class="string">"dashscope_api_key"</span>] = get_from_dict_or_env(</span><br><span class="line">    values, <span class="string">"dashscope_api_key"</span>, <span class="string">"DASHSCOPE_API_KEY"</span></span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> dashscope</span><br><span class="line">  <span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">raise</span> ImportError(</span><br><span class="line">      <span class="string">"Could not import dashscope python package. "</span></span><br><span class="line">      <span class="string">"Please install it with `pip install dashscope`."</span></span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    values[<span class="string">"client"</span>] = dashscope.Generation</span><br><span class="line">  <span class="keyword">except</span> AttributeError:</span><br><span class="line">    <span class="keyword">raise</span> ValueError(</span><br><span class="line">      <span class="string">"`dashscope` has no `Generation` attribute, this is likely "</span></span><br><span class="line">      <span class="string">"due to an old version of the dashscope package. Try upgrading it "</span></span><br><span class="line">      <span class="string">"with `pip install --upgrade dashscope`."</span></span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">return</span> values</span><br></pre></td></tr></table></figure>

<p>首先一上来就是执行<code>get_from_dict_or_env</code>，这个方法将会在<code>values</code>中获取<code>dashscope_api_key</code>，如果获取不到，则从<code>os.environ</code>中获取<code>DASHSCOPE_API_KEY</code>。</p>
<p>既然知道这个，那就好办了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.environ[<span class="string">"DASHSCOPE_API_KEY"</span>] = <span class="string">"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></span><br></pre></td></tr></table></figure>

<p>这样<code>Tongyi</code>就知道你的<code>api-key</code>了。</p>
<h2 id="env配置"><a href="#env配置" class="headerlink" title="env配置"></a>env配置</h2><p>当然，方法是有很多的。除了单纯的使用<code>os</code>显性地配置以外，官方提出，我们最好不要在代码中明码显示我们的<code>api-key</code>，这将会带来一定的风险。</p>
<p>当然，官方也推荐了一种方法：使用<code>.env</code>文件存储<code>api-key</code>。</p>
<p>比较取巧的是，<code>.env</code>文件可以通过<code>load_dotenv</code>加载：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dotenv <span class="keyword">import</span> load_dotenv</span><br><span class="line">load_dotenv()</span><br></pre></td></tr></table></figure>

<p>同样也非常方便。</p>
<blockquote>
<p>**P.S.**：我不太确定是在哪里出了问题，现在<code>.env</code>配置失效了，只能使用<code>os.environ</code>的方式配置。</p>
</blockquote>
<h2 id="streamlit配置"><a href="#streamlit配置" class="headerlink" title="streamlit配置"></a>streamlit配置</h2><p>我们在<code>OpenAI</code>的教程中能够更多地看到<code>streamlit</code>的存在。主要是因为，<code>streamlit</code>能够非常方便地给出一个<code>demo</code>界面，从而为用户更快地测试与迭代。</p>
<p>当然，<code>streamlit</code>也有独特的部分，比如<code>streamlit</code>能够自动的将<code>api-key</code>存储在<code>secrets.toml</code>文件中，从而实现<code>api-key</code>的隐藏。</p>
<p><code>secrets.toml</code>文件样例为：</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">DASHSCOPE_API_KEY</span> = <span class="string">"sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>**P.S.**：需要注意的是，<code>toml</code>文件必须要为字符串增加双引号，否则将会抛出编码错误。</p>
</blockquote>
<p>为了读取<code>api-key</code>，<code>streamlit</code>提供了<code>secrets</code>成员变量，其最初定义是这样的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Secrets</span>(Mapping[<span class="built_in">str</span>, <span class="type">Any</span>]):</span><br><span class="line">  <span class="string">"""A dict-like class that stores secrets.</span></span><br><span class="line"><span class="string">  Parses secrets.toml on-demand. Cannot be externally mutated.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Safe to use from multiple threads.</span></span><br><span class="line"><span class="string">  """</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, file_paths: <span class="built_in">list</span>[<span class="built_in">str</span>]</span>):</span><br><span class="line">    <span class="comment"># Our secrets dict.</span></span><br><span class="line">    self._secrets: Mapping[<span class="built_in">str</span>, <span class="type">Any</span>] | <span class="literal">None</span> = <span class="literal">None</span></span><br><span class="line">    self._lock = threading.RLock()</span><br><span class="line">    self._file_watchers_installed = <span class="literal">False</span></span><br><span class="line">    self._file_paths = file_paths</span><br><span class="line"></span><br><span class="line">    self.file_change_listener = Signal(</span><br><span class="line">      doc=<span class="string">"Emitted when a `secrets.toml` file has been changed."</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>secrets</code>表现类似<code>Java</code>中的<code>ConcurrentHashMap</code>一般，既有字典的一部分，又有线程安全的一部分。</p>
<p>而在定义<code>secrets</code>的过程中，通过上锁的方式，在<code>streamlit</code>的生命周期中实现了单例模式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 根据配置文件`secrets.toml`获取锁</span></span><br><span class="line">SECRETS_FILE_LOCS: Final[<span class="built_in">list</span>[<span class="built_in">str</span>]] = [</span><br><span class="line">    file_util.get_streamlit_file_path(<span class="string">"secrets.toml"</span>),</span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> The order here is important! Project-level secrets should overwrite global</span></span><br><span class="line">    <span class="comment"># secrets.</span></span><br><span class="line">    file_util.get_project_streamlit_file_path(<span class="string">"secrets.toml"</span>),</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 创建单例</span></span><br><span class="line">secrets_singleton: Final = Secrets(SECRETS_FILE_LOCS)</span><br><span class="line"><span class="comment"># streamlit的成员对象</span></span><br><span class="line">secrets = _secrets_singleton</span><br></pre></td></tr></table></figure>

<p>这也就意味着，无论我们使用多少个<code>Agent</code>协同进行，都将读取同一个<code>api-key</code>。</p>
<p>最终在使用的时候，也就能够直接这么做：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> streamlit <span class="keyword">as</span> st</span><br><span class="line">llm = Tongyi(</span><br><span class="line">  dashscope_api_key = st.secrets[<span class="string">"DASHSCOPE_API_KEY"</span>]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>同样也是非常的方便。</p>
<h1 id="PromptTemplate"><a href="#PromptTemplate" class="headerlink" title="PromptTemplate"></a>PromptTemplate</h1><p>当我们构造了<code>Tongyi</code>实例之后，我们就需要完善一个<code>prompt</code>模板了，在实际使用中，就会用到<code>PromptTempate</code>。这是个啥呢？是<code>langchain_core.prompts</code>中的一个类。在他的构造函数中，他接受这么几个参数：</p>
<ul>
<li><code>template</code> -&gt; 模板，也就是我们规定其中固定的部分，然后留下灵活填入的部分，叫做模板。例如：<code>Hello, {name}</code>，这串字符串就是模板，需要灵活填入的就是这个<code>name</code>；</li>
<li>input_variables -&gt; 输入变量，输入变量是一个列表，无论输入一个两个都是一个列表，按照模板中需要填入的变量顺序进行匹配</li>
<li>partial_variables -&gt; 预置变量，输入变量是一个<code>dict</code>字典，键是变量名，值是变量值。这个参数主要是为了将变量值直接预先填入<code>prompt</code>模板中，而不像<code>input_variables</code>需要渲染。</li>
<li>template_format -&gt; 模板格式，默认是<code>f-string</code>，但是也可以是<code>jinja2</code>，还可以是<code>mustache</code>。</li>
<li>validate_template -&gt; 是否验证模板，默认是<code>True</code></li>
</ul>
<blockquote>
<p>**P.S.**：关于<code>partial_variables</code>，这个参数是<code>langchain</code>提供的一个功能，可以预置变量值，而不用每次都渲染。举个简单的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">template_str = <span class="string">"Hello, {name}. Welcome to {place}. Today's weather is {weather}."</span></span><br></pre></td></tr></table></figure>

<p>其中，假设<code>place = "Wonderland"</code>。如果<code>place</code>是<code>partial_variables</code>，那么<code>langchain</code>会自动将<code>place</code>的值填入模板中。在<code>PromptTemplate</code>渲染的过程中，我们渲染的<strong>并不是</strong>字符串<code>"Hello, {name}. Welcome to {place}. Today's weather is {weather}."</code>，<strong>而是</strong>字符串<code>"Hello, {name}. Welcome to Wonderland. Today's weather is {weather}."</code>。</p>
<p>**P.P.S.**：关于模板，需要说明的是，<code>langchain</code>默认模板为<code>f-string</code>模板，并强烈建议不要使用非受信的<code>jinja2</code>模板。这主要是因为<code>jinja2</code>的功能过于强大，它可以在<code>prompt</code>中执行<code>Python</code>代码。举个比较简单的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">template_str = <span class="string">"""</span></span><br><span class="line"><span class="string">Hello, {{ name }}</span></span><br><span class="line"><span class="string">{% if 2 + 2 == 4 %}</span></span><br><span class="line"><span class="string">  2 + 2 is indeed 4</span></span><br><span class="line"><span class="string">{% endif %}</span></span><br><span class="line"><span class="string">{% set dangerous_code = '__import__("os").system("ls")' %}</span></span><br><span class="line"><span class="string">{{ eval(dangerous_code) }}</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>

<p>看到了吗，<code>jinja2</code>模板能够直接执行<code>Python</code>代码，从而直接执行了<code>linux</code>的<code>ls</code>命令。如果说写<code>jinja2</code>模板的人将更具备攻击性一点，则可以将服务器中的数据直接全部传出去，或者植入挖矿程序等。</p>
</blockquote>
<p>每次使用的时候都这么构造的话，会不会太麻烦了？没关系，官方已经给你想好了。默认情况下，<code>PromptTemplate</code>将使用<code>f-string</code>模板，所以可以直接这么写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prompt = PromptTemplate.from_template(<span class="string">"Hello, {name}"</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>P.S.：</strong>：直接用<code>PromptTemplate</code>构造函数与<code>PromptTemplate.from_template</code>构造基本没有区别，<code>from_template</code>只是为了方便使用者仅需要考虑输入<code>f-string</code>模板的<code>prompt</code>而设计的。</p>
</blockquote>
<p>当然，你可能会疑惑，这样子设置，他怎么知道自己的<code>input_variables</code>呢？答案就在源码中的<code>get_template_variables</code>方法，它能够将传递的<code>prompt</code>模板中的变量解析出来，并返回一个经过排序的列表。</p>
<p>最终，<code>PromptTemplate</code>无论是使用<code>from_template</code>还是直接使用构造函数，最终都会返回一个<code>PromptTemplate</code>对象。</p>
<h2 id="LLMChain"><a href="#LLMChain" class="headerlink" title="LLMChain"></a>LLMChain</h2><p><code>LLMChain</code>的构造函数主要接受两个参数，一个是<code>LLM</code>实例，一个是<code>prompt</code>模板。就像这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llm_chain = LLMChain(llm=llm, prompt=prompt)</span><br></pre></td></tr></table></figure>

<p>本质上，<code>LLMChain</code>在获得<code>LLM</code>实例与<code>prompt</code>模板后，会通过<code>LLMChain</code>的<code>_call</code>方法执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_call</span>(<span class="params"></span></span><br><span class="line"><span class="params">  self,</span></span><br><span class="line"><span class="params">  inputs: <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="type">Any</span>],</span></span><br><span class="line"><span class="params">  run_manager: <span class="type">Optional</span>[CallbackManagerForChainRun] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, <span class="built_in">str</span>]:</span><br><span class="line">  response = self.generate([inputs], run_manager=run_manager)</span><br><span class="line">  <span class="keyword">return</span> self.create_outputs(response)[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>这里主要调用了两个部分，分别是<code>generate</code>跟<code>create_outputs</code>两个。</p>
<p><code>generate</code>主要是通过调用<code>prep_prompt</code>方法构造提示，然后根据<code>llm</code>实例的类型生成具体的<code>LLMResult</code>类。</p>
<p>最终，也就由<code>LLMChain</code>给出结果。</p>
<h2 id="更换掉LLMChain（可选）"><a href="#更换掉LLMChain（可选）" class="headerlink" title="更换掉LLMChain（可选）"></a>更换掉LLMChain（可选）</h2><p>比较尴尬的是，<code>LLMChain</code>有一个注解（<del>或者说你比较喜欢叫他装饰器也行</del>）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@deprecated(<span class="params"></span></span></span><br><span class="line"><span class="params"><span class="meta">  since=<span class="string">"0.1.17"</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">  alternative=<span class="string">"RunnableSequence, e.g., `prompt | llm`"</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta">  removal=<span class="string">"0.3.0"</span>,</span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)</span></span><br></pre></td></tr></table></figure>

<p>从<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="5.783ex" height="1.579ex" role="img" focusable="false" viewBox="0 -676 2556 698"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(778,0)"></path></g><g data-mml-node="mn" transform="translate(1278,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(278,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(778,0)"></path></g></g></g></svg></mjx-container>开始支持，从<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="4.652ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 2056 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(778,0)"></path></g><g data-mml-node="mn" transform="translate(1278,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(278,0)"></path></g></g></g></svg></mjx-container>开始取消支持。如果有需要的话，可以提前修改为<code>TransformChain</code>。</p>
<p>修改起来也还算比较简单。原来我们使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llm_chain = LLMChain(llm=llm, prompt=prompt)</span><br></pre></td></tr></table></figure>

<p>需要修改的也就只有这里，<code>PromptTemplate</code>没变，<code>StuffDocumentsChain</code>也没变，变的只有构造<code>chain</code>的方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">llm_chain = TransformChain(</span><br><span class="line">  llm=llm,</span><br><span class="line">  input_prompt=prompt,</span><br><span class="line">  output_key=<span class="string">"text"</span>,</span><br><span class="line">  transform = <span class="keyword">lambda</span> x: {<span class="string">"text"</span>: x}</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>当然，上面这是一个偷懒的方法。实际上，我们需要额外定义一个<code>func</code>方法，然后在构造函数中定义<code>transform = func</code>。</p>
<p>其中:</p>
<ul>
<li><code>llm</code>没有变化，还是以前的<code>llm</code>对象；</li>
<li><code>input_prompt</code>还是以前的<code>PromptTemplate</code>对象，只是名字改了；</li>
<li><code>output_key</code>是<code>llm</code>的输出字段名，这个是新东西，最终标记输出内容的键；</li>
<li><code>transform</code>，原名<code>transform_cb</code>，是一个<code>callback</code>函数，将<code>prompt</code>的输出包装为字典，键需要与<code>output_key</code>一致，内容可以原样输出，也可以稍做处理；</li>
</ul>
<p>当然，考虑到目前最新的版本只有<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="4.652ex" height="1.557ex" role="img" focusable="false" viewBox="0 -666 2056 688"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z" transform="translate(500,0)"></path><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z" transform="translate(778,0)"></path></g><g data-mml-node="mn" transform="translate(1278,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(278,0)"></path></g></g></g></svg></mjx-container>，如果并没有考虑升级事项，<code>LLMChain</code>是完全可以直接使用的。但如果考虑到长期维护，可能就需要更换为<code>TransformChain</code>。</p>
<h2 id="StuffDocumentsChain"><a href="#StuffDocumentsChain" class="headerlink" title="StuffDocumentsChain"></a>StuffDocumentsChain</h2><p><code>StuffDocumentsChain</code>的构造函数主要接受两个参数，一个是<code>LLMChain</code>实例，一个是<code>document_prompt</code>模板中代表植入文本的变量：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stf_chain = StuffDocumentsChain(</span><br><span class="line">  llm_chain = LLMChain(</span><br><span class="line">    llm=Tongyi(),</span><br><span class="line">    prompt=prompt,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    memory=memory</span><br><span class="line">  ),</span><br><span class="line">  document_variable_name=<span class="string">"text"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>与<code>PromptTemplate</code>类似，通过<code>document_variable_name</code>将文件内容添加到<code>prompt</code>模板中。</p>
<p>这里面需要注意的是，<code>document_variable_name</code>需要与<code>prompt</code>中指定的植入文本的内容一致。</p>
<p>比如，在最开始的时候，我们定义的<code>prompt</code>模板是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">prompt = <span class="string">""""</span></span><br><span class="line"><span class="string">{human_input} {chat_history} {text}</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>

<p>那么我们就需要将<code>document_variable_name</code>设置为<code>text</code>。</p>
<p>当然，你可能在某些教程上看到是这样的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">stf_chain = StuffDocumentsChain(</span><br><span class="line">  llm_chain = LLMChain(</span><br><span class="line">    llm=Tongyi(),</span><br><span class="line">    prompt=prompt,</span><br><span class="line">    verbose=<span class="literal">True</span>,</span><br><span class="line">    memory=memory,</span><br><span class="line">    output_key=<span class="string">"text"</span></span><br><span class="line">  ),</span><br><span class="line">  document_variable_name=<span class="string">"text"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这个时候，出现了<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.131ex" height="1.507ex" role="img" focusable="false" viewBox="0 -666 500 666"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></svg></mjx-container>个<code>text</code>！是不是意味着这两个<code>text</code>必须要对应起来呢？</p>
<p>还记得上文提到的<code>TransformChain</code>吗？一样的，<code>output_key</code>实际上仅代表输出时候的键值，而<code>document_variable_name</code>代表<code>prompt</code>模板中需要植入文本的变量，前者是输出的变量，后者是输入的变量，这两者在意义上是完全不一致的。</p>
<p>使用<code>StuffDocumentsChain</code>包装了<code>prompt</code>后，就需要交付大模型并生成解答了。</p>
<p>目前，使用的方法是<code>run</code>方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">response = stf_chain.run(</span><br><span class="line">  human_input=message,</span><br><span class="line">  chat_history=<span class="string">""</span>,</span><br><span class="line">  input_documents=load_documents(<span class="string">"http://120.26.106.143:5000/disease"</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>在这里，必要的字段包括三个部分，分别是<code>hunman_input</code>、<code>chat_history</code>和<code>input_documents</code>。这三个部分都比较好理解，分别是用户最新一次输入、聊天记录以及输入文件内容。</p>
<p>其中，<code>human_input</code>与<code>input_documents</code>就是原样输入，不需要额外处理。</p>
<p>而<code>chat_history</code>需要一段数组，说明以往的交互历史。如果明码传输的话，需要这么做：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chat_history = [</span><br><span class="line">  {<span class="string">"role"</span>: <span class="string">"user"</span>, <span class="string">"content"</span>: <span class="string">"我想了解一下糖尿病的症状。"</span>},</span><br><span class="line">  {<span class="string">"role"</span>: <span class="string">"assistant"</span>, <span class="string">"content"</span>: <span class="string">"糖尿病的主要症状包括频尿、口渴、饥饿感增加及体重下降等。"</span>},</span><br><span class="line">  {<span class="string">"role"</span>: <span class="string">"user"</span>, <span class="string">"content"</span>: <span class="string">"那它的治疗方法呢？"</span>},</span><br><span class="line">  {<span class="string">"role"</span>: <span class="string">"assistant"</span>, <span class="string">"content"</span>: <span class="string">"治疗方法通常涉及饮食控制、规律运动、监测血糖以及可能需要的药物治疗。"</span>}</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>如果你使用的是<code>langchain</code>的<code>ConversationBufferMemory</code>，并且利用<code>streamlit</code>的<code>session_state</code>作为全局变量存储，那么可以直接利用起来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化会话状态</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">"messages"</span> <span class="keyword">not</span> <span class="keyword">in</span> st.session_state:</span><br><span class="line">  st.session_state.messages = [{</span><br><span class="line">    <span class="string">"role"</span>: <span class="string">"assistant"</span>,</span><br><span class="line">    <span class="string">"content"</span>: <span class="string">"你好，我是医学千问机器人GraphAcademy。有什么需要帮忙的吗？"</span></span><br><span class="line">  }]</span><br><span class="line"><span class="comment"># 获取交互历史 - 针对多线程场景的懒加载提供`if`容错</span></span><br><span class="line">chat_history = st.session_state.messages <span class="keyword">if</span> st.session_state.messages <span class="keyword">else</span> <span class="string">""</span></span><br></pre></td></tr></table></figure>

<h1 id="ConversationBufferMemory"><a href="#ConversationBufferMemory" class="headerlink" title="ConversationBufferMemory"></a>ConversationBufferMemory</h1><p><code>ConversationBufferMemory</code>是<code>langchain</code>提供的一个会话记忆类，用于存储会话历史。<code>ConversationBufferMemory</code>继承自<code>BaseChatMemory</code>类，而<code>BaseChatMemory</code>中有一个<code>chat_memory</code>变量，其类型通过<code>Field</code>方法的<code>default_factory</code>参数指定了默认类型<code>InMemoryChatMessageHistory</code>。看来找到到答案了。继续追溯，发现<code>InMemoryChatMessageHistory</code>拥有成员变量<code>messages</code>，同样通过<code>Field</code>方法的<code>default_factory</code>参数指定了默认类型为<code>list</code>。</p>
<p>到头来，<code>ConversationBufferMemory</code>能够存储历史对话信息，究其根源就是因为它本身就是一个列表。也正是上文提到的，使用列表逐行存储历史信息。而追加存储信息也是触发了<code>InMemoryChatMessageHistory</code>类中的<code>add_message</code>方法。</p>
<p>那么，这个数组里面能够存储什么东西呢？按照<code>ConversationBufferMemory</code>中<code>get_buffer_string</code>方法的定义，我们可以看到这么一些内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_buffer_string</span>(<span class="params"></span></span><br><span class="line"><span class="params">    messages: <span class="type">Sequence</span>[BaseMessage], human_prefix: <span class="built_in">str</span> = <span class="string">"Human"</span>, ai_prefix: <span class="built_in">str</span> = <span class="string">"AI"</span></span></span><br><span class="line"><span class="params"></span>) -&gt; <span class="built_in">str</span>:</span><br><span class="line">  <span class="string">"""Convert a sequence of Messages to strings and concatenate them into one string.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Args:</span></span><br><span class="line"><span class="string">      messages: Messages to be converted to strings.</span></span><br><span class="line"><span class="string">      human_prefix: The prefix to prepend to contents of HumanMessages.</span></span><br><span class="line"><span class="string">      ai_prefix: THe prefix to prepend to contents of AIMessages.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Returns:</span></span><br><span class="line"><span class="string">      A single string concatenation of all input messages.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Example:</span></span><br><span class="line"><span class="string">      .. code-block:: python</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          from langchain_core import AIMessage, HumanMessage</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">          messages = [</span></span><br><span class="line"><span class="string">              HumanMessage(content="Hi, how are you?"),</span></span><br><span class="line"><span class="string">              AIMessage(content="Good, how are you?"),</span></span><br><span class="line"><span class="string">          ]</span></span><br><span class="line"><span class="string">          get_buffer_string(messages)</span></span><br><span class="line"><span class="string">          # -&gt; "Human: Hi, how are you?\nAI: Good, how are you?"</span></span><br><span class="line"><span class="string">  """</span></span><br><span class="line">  string_messages = []</span><br><span class="line">  <span class="keyword">for</span> m <span class="keyword">in</span> messages:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, HumanMessage):</span><br><span class="line">      role = human_prefix</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, AIMessage):</span><br><span class="line">      role = ai_prefix</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, SystemMessage):</span><br><span class="line">      role = <span class="string">"System"</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, FunctionMessage):</span><br><span class="line">      role = <span class="string">"Function"</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, ToolMessage):</span><br><span class="line">      role = <span class="string">"Tool"</span></span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">isinstance</span>(m, ChatMessage):</span><br><span class="line">      role = m.role</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">raise</span> ValueError(<span class="string">f"Got unsupported message type: <span class="subst">{m}</span>"</span>)</span><br><span class="line">    message = <span class="string">f"<span class="subst">{role}</span>: <span class="subst">{m.content}</span>"</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, AIMessage) <span class="keyword">and</span> <span class="string">"function_call"</span> <span class="keyword">in</span> m.additional_kwargs:</span><br><span class="line">      message += <span class="string">f"<span class="subst">{m.additional_kwargs[<span class="string">'function_call'</span>]}</span>"</span></span><br><span class="line">    string_messages.append(message)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">"\n"</span>.join(string_messages)</span><br></pre></td></tr></table></figure>

<p>意思就是，如果<code>ConversationBufferMemory</code>如果在某一时刻需要将存储的内容输出出来，就会把存储的<code>HumanMessage</code>、<code>AIMessage</code>、<code>SystemMessage</code>、<code>FunctionMessage</code>、<code>ToolMessage</code>以及<code>ChatMessage</code>中的角色提取出来，然后拼接在一起，而其他类型就会报错说类型不受支持。</p>
<p>所以，<code>ConversationBufferMemory</code>也就只能够存储<code>HumanMessage</code>、<code>AIMessage</code>、<code>SystemMessage</code>、<code>FunctionMessage</code>、<code>ToolMessage</code>以及<code>ChatMessage</code>在内的一条或者多条信息。这些也都是<code>langchain</code>为我们提供的消息接口，用于封装各种各样的消息。</p>
<p>这些消息最终也将通过<code>memory</code>参数传入<code>LLMChain</code>中，在后续植入<code>prompt</code>知识库的时候，也会进一步通过<code>chat_history</code>输入<code>StuffDocumentsChain</code>中。</p>
<p>其实，比较神奇的是，虽然比较推荐传入<code>ConversationBufferMemory</code>，其实无论是<code>LLMChain</code>的<code>memory</code>还是<code>StuffDocumentsChain</code>的<code>chat_history</code>，直接传入数组也都是一点问题没有的。因为本质上都是数组，只需要保证里面的内容是使用<code>langchain</code>所提供的各种<code>Message</code>对象即可。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>sakebow
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://sakebow.cn/2024/06/11/LLM/qwen-construct/" title="通义千问的小机器人到底是怎么个事">http://sakebow.cn/2024/06/11/LLM/qwen-construct/</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/langchain/" rel="tag"># langchain</a>
              <a href="/tags/qwen/" rel="tag"># qwen</a>
              <a href="/tags/LLM/" rel="tag"># LLM</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2024/06/11/experience/nginx-conf/" rel="prev" title="https转到http的nginx配置参考">
                  <i class="fa fa-angle-left"></i> https转到http的nginx配置参考
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/06/13/LLM/langchain-io-api/" rel="next" title="使用langchain异步获取网络信息">
                  使用langchain异步获取网络信息 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">鄂ICP备2020023162号-1 </a>
      <img src="http://images.sakebow.cn/icons/icp.png" alt="">
  </div>
  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">sakebow</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">57k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">3:26</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/sakebow" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.28/fancybox/fancybox.umd.js" integrity="sha256-ytMJGN3toR+a84u7g7NuHm91VIR06Q41kMWDr2pq7Zo=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/custom/add-background.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js","integrity":"sha256-mm3Re3y7xlvh+yCD+l/Zs1d+PU0AEad93MkWvljfm/s="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.3.0/wavedrom.min.js","integrity":"sha256-IRMDzTC+wK5stMucZ/XSXkeS5VNtxZ+/Bm8Mcqfoxdo="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.3.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="/js/third-party/tags/wavedrom.js"></script>

  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"ams","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
